#!/usr/bin/env ruby
#
# Usage: keychain-password chris@example.com
#
# Uses the OS X keychain to retrieve the stored password for the requested
# account

require 'open3'

def get_password(account)
  password_command = "security find-generic-password -g -a #{account} -D email"
  stdout_str, stderr_str, status = Open3.capture3(password_command) # Obviously I want it on stderr.....
  password_string = stderr_str.chomp
  password_match = password_string.match(/password: "(.*)"$/)
  if password_match
    password_match[1]
  end
end

def main
  account = ARGV.pop
  password = get_password(account)
  if password
    puts password
  else
    $stderr.puts %[Unable to retrieve password for account "#{account}"]
    exit 1
  end
end

main
